<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AD Authentication in Modules &mdash; Ansible collections  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=5707b69d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/ansible.css?v=c5b67dd2" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/antsibull-minimal.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/rtd-ethical-ads.css?v=289b023e" />

  
    <link rel="shortcut icon" href="../../../../_static/images/Ansible-Mark-RGB_Black.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=7f41d439"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Attributes guide" href="guide_attributes.html" />
    <link rel="prev" title="Microsoft.Ad" href="../index.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->




</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
    <li><a href="https://forum.ansible.com/" target="_blank">Ansible community forum</a></li>
    <li><a href="https://docs.ansible.com/" target="_blank">Documentation</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../../../../_static/images/Ansible-Mark-RGB_White.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Ansible Collections Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Ansible collections
          </a><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <label class="sr-only" for="q">Search docs:</label>
    <input type="text" class="st-default-search-input" id="q" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Collections:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Collection Index</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Collections in the Microsoft Namespace</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Microsoft.Ad</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#communication">Communication</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#scenario-guides">Scenario Guides</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#plugin-index">Plugin Index</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index_filter.html">Index of all Filter Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_inventory.html">Index of all Inventory Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_module.html">Index of all Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../environment_variables.html">Index of all Collection Environment Variables</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Ansible collections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Collection Index</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Collections in the Microsoft Namespace</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Microsoft.Ad</a></li>
      <li class="breadcrumb-item active">AD Authentication in Modules</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

  
           <div itemprop="articleBody">
             
  <section id="ad-authentication-in-modules">
<span id="ansible-collections-microsoft-ad-docsite-guide-ad-module-authentication"></span><h1>AD Authentication in Modules<a class="headerlink" href="#ad-authentication-in-modules" title="Link to this heading"></a></h1>
<p>A key requirement of the modules used inside this collection is being able to authenticate a user to the domain controller when managing a resource. This guide will cover the different options available for this scenario.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This guide covers authentication to a domain controller when using a module on a Windows host. See <a class="reference internal" href="guide_ldap_connection.html#ansible-collections-microsoft-ad-docsite-guide-ldap-connection-authentication"><span class="std std-ref">LDAP Authentication</span></a> for information on how authentication is done when using plugins running on Linux.</p>
</div>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#implicit-authentication" id="id1">Implicit Authentication</a></p></li>
<li><p><a class="reference internal" href="#become" id="id2">Become</a></p></li>
<li><p><a class="reference internal" href="#explicit-credentials" id="id3">Explicit Credentials</a></p></li>
</ul>
</nav>
<section id="implicit-authentication">
<span id="ansible-collections-microsoft-ad-docsite-guide-ad-module-authentication-implicit-auth"></span><h2><a class="toc-backref" href="#id1" role="doc-backlink">Implicit Authentication</a><a class="headerlink" href="#implicit-authentication" title="Link to this heading"></a></h2>
<p>The first and simplest option is to use the connection user’s existing credentials during authentication. This avoids having to specify a username and password in the module’s parameters, but it does require that the connection method used by Ansible supports credential delegation. For example using CredSSP authentication with the <code class="docutils literal notranslate"><span class="pre">winrm</span></code> and <code class="docutils literal notranslate"><span class="pre">psrp</span></code> connection plugin, or using Kerberos delegation. Other authentication options, like NTLM, do not support credential delegation and will not work with implicit authentication.</p>
<p>The only way to test out if implicit authentication is available is to run the module and see if it works. If it does not work then the error will most likely contain the message <code class="docutils literal notranslate"><span class="pre">Failed</span> <span class="pre">to</span> <span class="pre">contact</span> <span class="pre">the</span> <span class="pre">AD</span> <span class="pre">server</span></code>.</p>
</section>
<section id="become">
<span id="ansible-collections-microsoft-ad-docsite-guide-ad-module-authentication-become"></span><h2><a class="toc-backref" href="#id2" role="doc-backlink">Become</a><a class="headerlink" href="#become" title="Link to this heading"></a></h2>
<p>If implicit authentication is not available, the module can be run with <code class="docutils literal notranslate"><span class="pre">become</span></code> that specifies the username and password to use for authentication.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use become with connection credentials</span>
<span class="w">  </span><span class="nt">microsoft.ad.user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyUser</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runas</span>
<span class="w">  </span><span class="nt">become_flags</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logon_type=new_credentials logon_flags=netcredentials_only</span>
<span class="w">  </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ansible_become_user</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">ansible_become_pass</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_password</span><span class="nv"> </span><span class="s">}}&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">runas</span></code> method is used on Windows and the <code class="docutils literal notranslate"><span class="pre">become_flags</span></code> will specify that the credentials should be used for network authentication only. The <code class="docutils literal notranslate"><span class="pre">ansible_become_user</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_become_pass</span></code> variables specify the username and password to use for authentication. It is important that both of these variables are set to a valid username and password or else the authentication will fail.</p>
<p>It is also possible to use the <code class="docutils literal notranslate"><span class="pre">SYSTEM</span></code> account for become. This will have the module use the AD computer account for that host when authenticating with the target DC rather than an explicit username and password. The AD computer account must still have the required rights to perform the operation requested.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use machine account for authentication</span>
<span class="w">  </span><span class="nt">microsoft.ad.user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyUser</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">become_method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runas</span>
<span class="w">  </span><span class="nt">become_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SYSTEM</span>
</pre></div>
</div>
</section>
<section id="explicit-credentials">
<span id="ansible-collections-microsoft-ad-docsite-guide-ad-module-authentication-explicit-creds"></span><h2><a class="toc-backref" href="#id3" role="doc-backlink">Explicit Credentials</a><a class="headerlink" href="#explicit-credentials" title="Link to this heading"></a></h2>
<p>The final option is to specify the username and password as module options. This can be done in two ways; with the <code class="docutils literal notranslate"><span class="pre">domain_username</span></code> and <code class="docutils literal notranslate"><span class="pre">domain_password</span></code> options, or with the <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code> option. An example of both methods is shown below.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use domain_username and domain_password</span>
<span class="w">  </span><span class="nt">microsoft.ad.user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyUser</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">    </span><span class="nt">domain_username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">domain_password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_password</span><span class="nv"> </span><span class="s">}}&#39;</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Use domain_credentials</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyUser</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">domain_credentials</span><span class="p p-Indicator">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_user</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ansible_password</span><span class="nv"> </span><span class="s">}}&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code> option was added in version 1.6.0 of this collection.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code> option without the <code class="docutils literal notranslate"><span class="pre">name</span></code> key, like in the above example, will be the credentials used for authentication with the default domain controller just like <code class="docutils literal notranslate"><span class="pre">domain_username</span></code> and <code class="docutils literal notranslate"><span class="pre">domain_password</span></code>. Using both options together is not supported and will result in an error.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code> option can also be used to specify server specific credentials. For example when attempting to lookup the identity of an AD object:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set member with lookup on different server</span>
<span class="w">  </span><span class="nt">microsoft.ad.group</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyGroup</span>
<span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<span class="w">    </span><span class="nt">members</span><span class="p">:</span>
<span class="w">      </span><span class="nt">add</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GroupOnDefaultDC</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GroupOnDefaultDC2</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GroupOnOtherDC</span>
<span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OtherDC</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GroupOnThirdDC</span>
<span class="w">        </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ThirdDC</span>
<span class="w">    </span><span class="nt">domain_credentials</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UserForDefaultDC</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PasswordForDefaultDC</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OtherDC</span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UserForOtherDC</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PasswordForOtherDC</span>
</pre></div>
</div>
<p>In the case above there are three members being added to the group:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GroupOnDefaultDC</span></code> - Will be looked up on the default domain controller using <code class="docutils literal notranslate"><span class="pre">UserForDefaultDC</span></code> and <code class="docutils literal notranslate"><span class="pre">PasswordForDefaultDC</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GroupOnDefaultDC2</span></code> - Same as the above just specified as a dictionary</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GroupOnOtherDC</span></code> - Will be looked up on <code class="docutils literal notranslate"><span class="pre">OtherDC</span></code> using <code class="docutils literal notranslate"><span class="pre">UserForOtherDC</span></code> and <code class="docutils literal notranslate"><span class="pre">PasswordForOtherDC</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GroupOnThirdDC</span></code> - Will be looked up on <code class="docutils literal notranslate"><span class="pre">ThirdDC</span></code> using the implicit user authentication context</p></li>
</ul>
<p>The value for <code class="docutils literal notranslate"><span class="pre">server</span></code> must correspond to a <code class="docutils literal notranslate"><span class="pre">name</span></code> entry in <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code>. If the server is not specified in <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code>, the module will default to using the <code class="docutils literal notranslate"><span class="pre">domain_username/domain_password</span></code> or implicit user authentication.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default (no <code class="docutils literal notranslate"><span class="pre">name</span></code> key) entry in <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code> is only used for lookups without an explicit server set. The <code class="docutils literal notranslate"><span class="pre">domain_username</span></code> and <code class="docutils literal notranslate"><span class="pre">domain_password</span></code> credential will be used for all connections unless there is an explicit server entry in <code class="docutils literal notranslate"><span class="pre">domain_credentials</span></code>.</p>
</div>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../index.html" class="btn btn-neutral float-left" title="Microsoft.Ad" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="guide_attributes.html" class="btn btn-neutral float-right" title="Attributes guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible contributors.</p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->

</body>
</html>